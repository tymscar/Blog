<!doctype html><html lang=en><head><title>Automating What Backblaze Lifecycle Rules Don't Do Instantly :: The Tymscar Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Backblaze's 'keep last version' rule doesn't delete old versions immediately. I found 21,000 extras and automated the cleanup with rclone."><meta name=keywords content="backblaze,b2,rclone,truenas,backup,file versions"><meta name=robots content="noodp"><link rel=canonical href=https://blog.tymscar.com/posts/backblazeb2cleanup/><link rel=stylesheet href=https://blog.tymscar.com/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://blog.tymscar.com/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://blog.tymscar.com/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://blog.tymscar.com/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://blog.tymscar.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://blog.tymscar.com/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://blog.tymscar.com/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://blog.tymscar.com/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://blog.tymscar.com/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://blog.tymscar.com/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://blog.tymscar.com/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://blog.tymscar.com/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://blog.tymscar.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://blog.tymscar.com/style.css><link rel="shortcut icon" href=https://blog.tymscar.com/img/favicon/favicon.ico><link rel=apple-touch-icon href=https://blog.tymscar.com/apple-touch-icon.png><meta name=twitter:card content="summary"><meta name=twitter:site content="google.com"><meta name=twitter:creator content="tymscar"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Automating What Backblaze Lifecycle Rules Don't Do Instantly"><meta property="og:description" content="Backblaze's 'keep last version' rule doesn't delete old versions immediately. I found 21,000 extras and automated the cleanup with rclone."><meta property="og:url" content="https://blog.tymscar.com/posts/backblazeb2cleanup/"><meta property="og:site_name" content="The Tymscar Blog"><meta property="og:image" content="https://blog.tymscar.com/backblaze-dedup/duplicates.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-12-25 12:00:00 +0000 UTC"><img src=https://librecounter.tymscar.com/counter.svg referrerpolicy=unsafe-url width=0 height=0 alt loading=eager decoding=async style=display:none;border:none;outline:none;margin:0;padding:0></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Tymscar</div></a></div></div></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.tymscar.com/posts/backblazeb2cleanup/>Automating What Backblaze Lifecycle Rules Don&rsquo;t Do Instantly</a></h1><div class=post-meta><time class=post-date>2025-12-25</time><span class=post-author>Oscar Molnar</span><span class=post-reading-time>3 min read (608 words)</span></div><span class=post-tags>#<a href=https://blog.tymscar.com/tags/homelab/>homelab</a>&nbsp;
#<a href=https://blog.tymscar.com/tags/backblaze/>backblaze</a>&nbsp;
#<a href=https://blog.tymscar.com/tags/truenas/>truenas</a>&nbsp;
#<a href=https://blog.tymscar.com/tags/nixos/>nixos</a>&nbsp;
#<a href=https://blog.tymscar.com/tags/backups/>backups</a>&nbsp;</span><div class=post-content><div><p>I recently moved from Synology to TrueNAS and set up cloud backups to Backblaze B2. I have two buckets: one for important files like documents, and one for homelab services. The services bucket backs up things like qcow2 disk images for my VMs, some of which are hundreds of gigabytes.</p><p>When I created the buckets, I set the <a href=https://www.backblaze.com/docs/cloud-storage-lifecycle-rules>lifecycle rule</a> to &ldquo;Keep only the last version of the file.&rdquo; I assumed this meant Backblaze would automatically replace old versions when new ones arrived. It doesn&rsquo;t work that way.</p><h2 id=the-problem>The problem<a href=#the-problem class=hanchor arialabel=Anchor>#</a></h2><p>After a few days of backups, I noticed something odd. My bucket was showing way more storage than expected. Looking at individual files, I could see multiple versions stacking up despite the lifecycle rule being set.</p><p><img src=/backblaze-dedup/duplicates.png alt="Multiple file versions in Backblaze"></p><p>I contacted Backblaze support to figure out what was going on. The support agent explained that lifecycle rules take 48 hours to kick in. Even after that, the cleanup only runs once every 24 hours. So if TrueNAS pushes a new version of a 100GB qcow2 file, both versions exist on Backblaze for up to 24 hours before the old one gets deleted.</p><p>This matters because Backblaze charges based on daily usage, not monthly snapshots. Every day they calculate how much data you&rsquo;re storing and add it to your bill. If I back up my services every 6 hours and have a 100GB file, instead of ending the day with a single 100GB file, I could have 4 or 5 versions sitting there. That&rsquo;s potentially 500GB of billable storage for what should be 100GB. The cleanup doesn&rsquo;t run at exactly 24 hours either, so it can drift even worse. Multiply this across dozens of large files and it adds up fast.</p><p>When I checked how many old versions had accumulated, the numbers were worse than I expected:</p><table><thead><tr><th>Bucket</th><th>Old versions</th></tr></thead><tbody><tr><td><code>tymscar-truenas-services</code></td><td>21,377</td></tr><tr><td><code>tymscar-truenas-important</code></td><td>7</td></tr></tbody></table><p>Over 21,000 hidden versions in the services bucket alone.</p><h2 id=the-fix>The fix<a href=#the-fix class=hanchor arialabel=Anchor>#</a></h2><p>The support agent suggested I could either wait for the lifecycle rules to eventually clean things up, or delete the old versions manually. Waiting meant paying for storage I didn&rsquo;t need. Manual deletion through the web UI for 21,000 files wasn&rsquo;t happening.</p><p>Enter <code>rclone cleanup</code>. This command specifically removes old versions from B2 buckets. One command, all the hidden versions gone:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rclone cleanup b2:tymscar-truenas-services
</span></span></code></pre></div><p>I set up rclone on my NixOS homelab server using home-manager, with the B2 credentials stored in agenix. If you&rsquo;ve read my <a href=/posts/nixosdockerwithsecrets/>previous post on Docker containers with secrets</a>, you&rsquo;ll recognise the pattern. Then I added a simple systemd timer that runs <code>rclone cleanup</code> every 15 minutes against both TrueNAS buckets:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  systemd<span style=color:#f92672>.</span>services<span style=color:#f92672>.</span>b2-cleanup <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Clean up old B2 file versions&#34;</span>;
</span></span><span style=display:flex><span>    serviceConfig <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      Type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;oneshot&#34;</span>;
</span></span><span style=display:flex><span>      ExecStart <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>bash<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/bash -c &#39;</span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>rclone<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/rclone cleanup b2:tymscar-truenas-services &amp;&amp; </span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>rclone<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/rclone cleanup b2:tymscar-truenas-important&#39;&#34;</span>;
</span></span><span style=display:flex><span>      User <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tymscar&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  systemd<span style=color:#f92672>.</span>timers<span style=color:#f92672>.</span>b2-cleanup <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    wantedBy <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;timers.target&#34;</span> ];
</span></span><span style=display:flex><span>    timerConfig <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      OnBootSec <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5min&#34;</span>;
</span></span><span style=display:flex><span>      OnUnitActiveSec <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;15min&#34;</span>;
</span></span><span style=display:flex><span>      Persistent <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After the first run, all 21,000+ old versions were gone. Now the timer catches any new ones before they can accumulate. Instead of paying for 500GB of duplicate versions, I briefly hit 200GB during a backup and it&rsquo;s cleaned up within 15 minutes.</p><h2 id=lessons-learned>Lessons learned<a href=#lessons-learned class=hanchor arialabel=Anchor>#</a></h2><p>Backblaze&rsquo;s lifecycle rules work, but they&rsquo;re not instant. If you&rsquo;re backing up large files frequently, those 24-hour windows add up. The <code>rclone cleanup</code> command is the missing piece that should probably be in every TrueNAS-to-Backblaze backup guide.</p><p>I also learned that Backblaze support is genuinely helpful if you can get past the chatbot. Typing &ldquo;real human please&rdquo; into the initial prompt seems to do the trick.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><a href=https://blog.tymscar.com/posts/gleamaoc2025/ class="button inline next">[<span class=button__text>I Tried Gleam for Advent of Code, and I Get the Hype</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>