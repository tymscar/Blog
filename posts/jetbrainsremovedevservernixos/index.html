<!doctype html><html lang=en><head><title>Running Jetbrains remote dev servers on NixOS :: The Tymscar Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I participated in this year's HTM CTF. Here is my experience!"><meta name=keywords content="nix,development,linux,technical"><meta name=robots content="noodp"><link rel=canonical href=/posts/jetbrainsremovedevservernixos/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/blue.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="google.com"><meta name=twitter:creator content="tymscar"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Running Jetbrains remote dev servers on NixOS"><meta property="og:description" content="I participated in this year's HTM CTF. Here is my experience!"><meta property="og:url" content="/posts/jetbrainsremovedevservernixos/"><meta property="og:site_name" content="The Tymscar Blog"><meta property="og:image" content="/img/favicon/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-07-10 00:33:45 +0100 +0100"></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Tymscar</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=/posts/jetbrainsremovedevservernixos/>Running Jetbrains remote dev servers on NixOS</a></h1><div class=post-meta><span class=post-date>2023-07-10</span>
<span class=post-author>:: Oscar Molnar</span></div><span class=post-tags>#<a href=/tags/nix/>nix</a>&nbsp;
#<a href=/tags/development/>development</a>&nbsp;
#<a href=/tags/linux/>linux</a>&nbsp;
#<a href=/tags/technical/>technical</a>&nbsp;</span><div class=post-content><div><p><img src=/jb-nix-remote-server/project.png alt="A remote project"></p><p>For the past year or so I have been very interested in <a href=https://nixos.org/>NixOS and Nix</a> in general.
I have set it up as my <a href=https://github.com/tymscar/dotfiles>main OS on my desktop</a>, I have used it on remote VPS instances, and I have used it for local projects as well in the shape of nix environments.</p><p>However there has always been an issue, and that is hosting a remote Jetbrains instance on it that I can then connect to from anywhere else.</p><p>Long story short, the way it works is when a client tries to connect to the server, it checks to see if there is any instance of a Jetbrains IDE running.
If there is none, it tries to start one. All good up to this point, however, here is where the problems start: If there is no IDE present, or if it can&rsquo;t detect it, it sends over a package and it tries installing that, and because NixOS is not your standard Linux distro, it fails every time.</p><p>I have looked far and wide online and there hasn&rsquo;t been a good solution until I found this issue on GitHub: <a href=https://github.com/NixOS/nixpkgs/issues/153335>https://github.com/NixOS/nixpkgs/issues/153335</a></p><p>None of the solutions there were made specifically for Webstorm, which is what I needed, but the one by <a href=https://github.com/NixOS/nixpkgs/issues/153335#issuecomment-1465833977>Nicolas Guilloux</a>, for PHPStorm, was something that in the end managed to work.</p><p>I have then spent a handful of hours trying to understand how does the patch work and why is it needed because I wanted to see if I can simplify it to make it less likey to break in future updates.</p><p>I managed to boil it down to 2 modification, and looking back through the history as far as I had patience for, this new patch seems to work with all of the previous versions, which gives me hope that it will continue to work in the future.</p><p>Here is my modified patch, if you want to follow along, save this as <code>JetbrainsRemoteDev.patch</code> in the same folder as your nix config:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>--- a/plugins/remote-dev-server/bin/launcher.sh
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/plugins/remote-dev-server/bin/launcher.sh
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -327,6 +327,8 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   REMOTE_DEV_SERVER_USE_SELF_CONTAINED_LIBS=1
</span></span><span style=display:flex><span> fi
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>+REMOTE_DEV_SERVER_USE_SELF_CONTAINED_LIBS=0
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> if [ $REMOTE_DEV_SERVER_USE_SELF_CONTAINED_LIBS -eq 1 ]; then
</span></span><span style=display:flex><span>   SELFCONTAINED_LIBS=&#34;$REMOTE_DEV_SERVER_DIR/selfcontained/lib&#34;
</span></span><span style=display:flex><span>   if [ ! -d &#34;$SELFCONTAINED_LIBS&#34; ]; then
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -568,3 +570,5 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     &#34;$LAUNCHER&#34; &#34;$STARTER_COMMAND&#34; &#34;$PROJECT_PATH&#34; &#34;$@&#34;
</span></span><span style=display:flex><span>     ;;
</span></span><span style=display:flex><span> esac
</span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+unset REMOTE_DEV_SERVER_USE_SELF_CONTAINED_LIBS
</span></span></span></code></pre></div></p><p>I have spent a few hours trying to see if I can get it to work without the patch at all by setting the command line option myself before running the server, or doing it in the overlay, but it would fail either because the variable would be set to 1 and it wouldn&rsquo;t find the libraries (in the store) or because the variable was 0 and at the end of the launch script it would still be set and used by the IDE later down the line.</p><p>I have also made a few modifications to the overlay which would give you the opportunity of selecting multiple Jetbrains IDEs that you would want to use as remote servers. It worked with all of the ones I have tried.</p><p>If you&rsquo;re following at home, you just have to add the overlay to your config, for example as such:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span>nixpkgs<span style=color:#f92672>.</span>overlays <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  (<span style=color:#e6db74>final</span>: <span style=color:#e6db74>prev</span>:
</span></span><span style=display:flex><span>  let
</span></span><span style=display:flex><span>    toolNames <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;phpstorm&#34;</span> <span style=color:#e6db74>&#34;webstorm&#34;</span>];
</span></span><span style=display:flex><span>    makeToolOverlay <span style=color:#f92672>=</span> <span style=color:#e6db74>toolName</span>: {
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>$</span>{toolName} <span style=color:#f92672>=</span> prev<span style=color:#f92672>.</span>jetbrains<span style=color:#f92672>.</span><span style=color:#960050;background-color:#1e0010>$</span>{toolName}<span style=color:#f92672>.</span>overrideAttrs (<span style=color:#e6db74>old</span>: {
</span></span><span style=display:flex><span>        patches <span style=color:#f92672>=</span> (old<span style=color:#f92672>.</span>patches <span style=color:#f92672>or</span> []) <span style=color:#f92672>++</span> [ <span style=color:#f92672>./</span><span style=color:#a6e22e>JetbrainsRemoteDev</span><span style=color:#f92672>.</span>patch ];
</span></span><span style=display:flex><span>        installPhase <span style=color:#f92672>=</span> (old<span style=color:#f92672>.</span>installPhase <span style=color:#f92672>or</span> <span style=color:#e6db74>&#34;&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>          makeWrapper <span style=color:#e6db74>&#34;$out/$pname/bin/remote-dev-server.sh&#34;</span> <span style=color:#e6db74>&#34;$out/bin/$pname-remote-dev-server&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>--</span>prefix <span style=color:#a6e22e>PATH</span> : <span style=color:#e6db74>&#34;$out/libexec/$pname:${final.lib.makeBinPath [ final.jdk final.coreutils final.gnugrep final.which final.git ]}&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>--</span>prefix <span style=color:#a6e22e>LD_LIBRARY_PATH</span> : <span style=color:#e6db74>&#34;${final.lib.makeLibraryPath ([ final.stdenv.cc.cc.lib final.libsecret final.e2fsprogs final.libnotify ])}&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>--</span>set<span style=color:#f92672>-</span>default <span style=color:#a6e22e>JDK_HOME</span> <span style=color:#e6db74>&#34;${final.jetbrains.jdk}&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>--</span>set<span style=color:#f92672>-</span>default <span style=color:#a6e22e>JAVA_HOME</span> <span style=color:#e6db74>&#34;${final.jetbrains.jdk}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  <span style=color:#f92672>in</span> { jetbrains <span style=color:#f92672>=</span> prev<span style=color:#f92672>.</span>jetbrains <span style=color:#f92672>//</span> builtins<span style=color:#f92672>.</span>foldl<span style=color:#e6db74>&#39; (acc: toolName: acc // makeToolOverlay toolName) {} toolNames; })
</span></span></span><span style=display:flex><span><span style=color:#e6db74>];</span></span></span></code></pre></div></p><p>Now all you have to do is add your favourite Jetbrains IDE to the <code>toolNames</code> list and don&rsquo;t forget to add it to your packages list as well, for example:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span>environment<span style=color:#f92672>.</span>systemPackages <span style=color:#f92672>=</span> with pkgs; [
</span></span><span style=display:flex><span>    <span style=color:#75715e># other packages here...</span>
</span></span><span style=display:flex><span>    jetbrains<span style=color:#f92672>.</span>webstorm
</span></span><span style=display:flex><span>    jetbrains<span style=color:#f92672>.</span>phpstorm
</span></span><span style=display:flex><span>    jetbrains<span style=color:#f92672>.</span>jdk 
</span></span><span style=display:flex><span>  ];</span></span></code></pre></div></p><p>Note <code>jetbrains.jdk</code> being there! Without it, none of this works, so do not forget to add it there!</p><p>Now you need to <code>sudo nixos-rebuild switch</code> and start the server. The naming of the utility depends on the IDE you want to use, in my case <code>webstorm-remote-dev-server run &lt;path to project></code>.</p><p>That is all, now you can just open up Jetbrains Gateway, go to the SSH tab and just connect to your instance by clicking on the project. It will be the one selected with the previous command!</p><p><img src=/jb-nix-remote-server/projects.png alt="Project list"></p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/hackthemidlandsctf2021/><span class=button__text>Hack The Midlands CTF 2021</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div></body></html>