<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>development on The Tymscar Blog</title><link>/tags/development/</link><description>Recent content in development on The Tymscar Blog</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Mon, 10 Jul 2023 00:33:45 +0100</lastBuildDate><atom:link href="/tags/development/index.xml" rel="self" type="application/rss+xml"/><item><title>Running Jetbrains remote dev servers on NixOS</title><link>/posts/jetbrainsremotedevservernixos/</link><pubDate>Mon, 10 Jul 2023 00:33:45 +0100</pubDate><guid>/posts/jetbrainsremotedevservernixos/</guid><description>For the past year or so I have been very interested in NixOS and Nix in general. I have set it up as my main OS on my desktop, I have used it on remote VPS instances, and I have used it for local projects as well in the shape of nix environments.
However there has always been an issue, and that is hosting a remote Jetbrains instance on it that I can then connect to from anywhere else.</description><content>&lt;p>&lt;img src="/jb-nix-remote-server/project.png" alt="A remote project">&lt;/p>
&lt;p>For the past year or so I have been very interested in &lt;a href="https://nixos.org/">NixOS and Nix&lt;/a> in general.
I have set it up as my &lt;a href="https://github.com/tymscar/dotfiles">main OS on my desktop&lt;/a>, I have used it on remote VPS instances, and I have used it for local projects as well in the shape of nix environments.&lt;/p>
&lt;p>However there has always been an issue, and that is hosting a remote Jetbrains instance on it that I can then connect to from anywhere else.&lt;/p>
&lt;p>Long story short, the way it works is when a client tries to connect to the server, it checks to see if there is any instance of a Jetbrains IDE running.
If there is none, it tries to start one. All good up to this point, however, here is where the problems start: If there is no IDE present, or if it can&amp;rsquo;t detect it, it sends over a package and it tries installing that, and because NixOS is not your standard Linux distro, it fails every time.&lt;/p>
&lt;p>I have looked far and wide online and there hasn&amp;rsquo;t been a good solution until I found this issue on GitHub: &lt;a href="https://github.com/NixOS/nixpkgs/issues/153335">https://github.com/NixOS/nixpkgs/issues/153335&lt;/a>&lt;/p>
&lt;p>None of the solutions there were made specifically for Webstorm, which is what I needed, but the one by &lt;a href="https://github.com/NixOS/nixpkgs/issues/153335#issuecomment-1465833977">Nicolas Guilloux&lt;/a>, for PHPStorm, was something that in the end managed to work.&lt;/p>
&lt;p>I have then spent a handful of hours trying to understand how does the patch work and why is it needed because I wanted to see if I can simplify it to make it less likey to break in future updates.&lt;/p>
&lt;p>I managed to boil it down to 2 modification, and looking back through the history as far as I had patience for, this new patch seems to work with all of the previous versions, which gives me hope that it will continue to work in the future.&lt;/p>
&lt;p>Here is my modified patch, if you want to follow along, save this as &lt;code>JetbrainsRemoteDev.patch&lt;/code> in the same folder as your nix config:
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-diff" data-lang="diff">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">--- a/plugins/remote-dev-server/bin/launcher.sh
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&lt;/span>&lt;span style="color:#a6e22e">+++ b/plugins/remote-dev-server/bin/launcher.sh
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">&lt;/span>&lt;span style="color:#75715e">@@ -327,6 +327,8 @@
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> REMOTE_DEV_SERVER_USE_SELF_CONTAINED_LIBS=1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">+REMOTE_DEV_SERVER_USE_SELF_CONTAINED_LIBS=0
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">+
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">&lt;/span> if [ $REMOTE_DEV_SERVER_USE_SELF_CONTAINED_LIBS -eq 1 ]; then
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SELFCONTAINED_LIBS=&amp;#34;$REMOTE_DEV_SERVER_DIR/selfcontained/lib&amp;#34;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> if [ ! -d &amp;#34;$SELFCONTAINED_LIBS&amp;#34; ]; then
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">@@ -568,3 +570,5 @@
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &amp;#34;$LAUNCHER&amp;#34; &amp;#34;$STARTER_COMMAND&amp;#34; &amp;#34;$PROJECT_PATH&amp;#34; &amp;#34;$@&amp;#34;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ;;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> esac
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">+
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">+unset REMOTE_DEV_SERVER_USE_SELF_CONTAINED_LIBS
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/p>
&lt;p>I have spent a few hours trying to see if I can get it to work without the patch at all by setting the command line option myself before running the server, or doing it in the overlay, but it would fail either because the variable would be set to 1 and it wouldn&amp;rsquo;t find the libraries (in the store) or because the variable was 0 and at the end of the launch script it would still be set and used by the IDE later down the line.&lt;/p>
&lt;p>I have also made a few modifications to the overlay which would give you the opportunity of selecting multiple Jetbrains IDEs that you would want to use as remote servers. It worked with all of the ones I have tried.&lt;/p>
&lt;p>If you&amp;rsquo;re following at home, you just have to add the overlay to your config, for example as such:
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-elixir" data-lang="elixir">&lt;span style="display:flex;">&lt;span>nixpkgs&lt;span style="color:#f92672">.&lt;/span>overlays &lt;span style="color:#f92672">=&lt;/span> [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#e6db74">final&lt;/span>: &lt;span style="color:#e6db74">prev&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> let
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> toolNames &lt;span style="color:#f92672">=&lt;/span> [&lt;span style="color:#e6db74">&amp;#34;phpstorm&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;webstorm&amp;#34;&lt;/span>];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> makeToolOverlay &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">toolName&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>{toolName} &lt;span style="color:#f92672">=&lt;/span> prev&lt;span style="color:#f92672">.&lt;/span>jetbrains&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">$&lt;/span>{toolName}&lt;span style="color:#f92672">.&lt;/span>overrideAttrs (&lt;span style="color:#e6db74">old&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> patches &lt;span style="color:#f92672">=&lt;/span> (old&lt;span style="color:#f92672">.&lt;/span>patches &lt;span style="color:#f92672">or&lt;/span> []) &lt;span style="color:#f92672">++&lt;/span> [ &lt;span style="color:#f92672">./&lt;/span>&lt;span style="color:#a6e22e">JetbrainsRemoteDev&lt;/span>&lt;span style="color:#f92672">.&lt;/span>patch ];
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> installPhase &lt;span style="color:#f92672">=&lt;/span> (old&lt;span style="color:#f92672">.&lt;/span>installPhase &lt;span style="color:#f92672">or&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>) &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> makeWrapper &lt;span style="color:#e6db74">&amp;#34;$out/$pname/bin/remote-dev-server.sh&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;$out/bin/$pname-remote-dev-server&amp;#34;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">--&lt;/span>prefix &lt;span style="color:#a6e22e">PATH&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;$out/libexec/$pname:${final.lib.makeBinPath [ final.jdk final.coreutils final.gnugrep final.which final.git ]}&amp;#34;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">--&lt;/span>prefix &lt;span style="color:#a6e22e">LD_LIBRARY_PATH&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;${final.lib.makeLibraryPath ([ final.stdenv.cc.cc.lib final.libsecret final.e2fsprogs final.libnotify ])}&amp;#34;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">--&lt;/span>set&lt;span style="color:#f92672">-&lt;/span>default &lt;span style="color:#a6e22e">JDK_HOME&lt;/span> &lt;span style="color:#e6db74">&amp;#34;${final.jetbrains.jdk}&amp;#34;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">--&lt;/span>set&lt;span style="color:#f92672">-&lt;/span>default &lt;span style="color:#a6e22e">JAVA_HOME&lt;/span> &lt;span style="color:#e6db74">&amp;#34;${final.jetbrains.jdk}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> };
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">in&lt;/span> { jetbrains &lt;span style="color:#f92672">=&lt;/span> prev&lt;span style="color:#f92672">.&lt;/span>jetbrains &lt;span style="color:#f92672">//&lt;/span> builtins&lt;span style="color:#f92672">.&lt;/span>foldl&lt;span style="color:#e6db74">&amp;#39; (acc: toolName: acc // makeToolOverlay toolName) {} toolNames; })
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">];&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/p>
&lt;p>Now all you have to do is add your favourite Jetbrains IDE to the &lt;code>toolNames&lt;/code> list and don&amp;rsquo;t forget to add it to your packages list as well, for example:
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-elixir" data-lang="elixir">&lt;span style="display:flex;">&lt;span>environment&lt;span style="color:#f92672">.&lt;/span>systemPackages &lt;span style="color:#f92672">=&lt;/span> with pkgs; [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># other packages here...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> jetbrains&lt;span style="color:#f92672">.&lt;/span>webstorm
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> jetbrains&lt;span style="color:#f92672">.&lt;/span>phpstorm
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> jetbrains&lt;span style="color:#f92672">.&lt;/span>jdk
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ];&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/p>
&lt;p>Note &lt;code>jetbrains.jdk&lt;/code> being there! Without it, none of this works, so do not forget to add it there!&lt;/p>
&lt;p>Now you need to &lt;code>sudo nixos-rebuild switch&lt;/code> and start the server. The naming of the utility depends on the IDE you want to use, in my case &lt;code>webstorm-remote-dev-server run &amp;lt;path to project&amp;gt;&lt;/code>.&lt;/p>
&lt;p>That is all, now you can just open up Jetbrains Gateway, go to the SSH tab and just connect to your instance by clicking on the project. It will be the one selected with the previous command!&lt;/p>
&lt;p>&lt;img src="/jb-nix-remote-server/projects.png" alt="Project list">&lt;/p></content></item></channel></rss>