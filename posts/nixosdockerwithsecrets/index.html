<!doctype html><html lang=en><head><title>Public Dotfiles, Private Secrets: My Nix OS Docker Workflow :: The Tymscar Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Run Docker containers on Nix OS, commit every line to GitHub, and still keep your API tokens private using Agenix and age."><meta name=keywords content="nix,linux,docker,secrets,nixos"><meta name=robots content="noodp"><link rel=canonical href=/posts/nixosdockerwithsecrets/><link rel=stylesheet href=/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css><link rel=stylesheet href=/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css><link rel=stylesheet href=/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css><link rel=stylesheet href=/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css><link rel=stylesheet href=/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=/img/favicon/favicon.ico><link rel=apple-touch-icon href=/apple-touch-icon.png><meta name=twitter:card content="summary"><meta name=twitter:site content="google.com"><meta name=twitter:creator content="tymscar"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Public Dotfiles, Private Secrets: My Nix OS Docker Workflow"><meta property="og:description" content="Run Docker containers on Nix OS, commit every line to GitHub, and still keep your API tokens private using Agenix and age."><meta property="og:url" content="/posts/nixosdockerwithsecrets/"><meta property="og:site_name" content="The Tymscar Blog"><meta property="og:image" content="/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-06-15 21:39:22 +0100 +0100"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Tymscar</div></a></div></div></header><div class=content><article class=post><h1 class=post-title><a href=/posts/nixosdockerwithsecrets/>Public Dotfiles, Private Secrets: My Nix OS Docker Workflow</a></h1><div class=post-meta><time class=post-date>2025-06-15</time><span class=post-author>Oscar Molnar</span><span class=post-reading-time>5 min read (991 words)</span></div><span class=post-tags>#<a href=/tags/nix/>nix</a>&nbsp;
#<a href=/tags/linux/>linux</a>&nbsp;
#<a href=/tags/docker/>docker</a>&nbsp;
#<a href=/tags/secrets/>secrets</a>&nbsp;
#<a href=/tags/nixos/>nixos</a>&nbsp;</span><div class=post-content><div><p>For the longest time I ran every container in my homelab on Proxmox. It did the job, but because I use NixOS on my main workstation and NixDarwin on my laptop, I eventually wanted the lab to follow the same declarative model. A few months ago I switched those machines to NixOS as well. Everything went smoothly except for one thing: moving the containers themselves.</p><p>The problem was secrets. I keep my entire configuration, including the lab, in a public <a href=https://github.com/tymscar/dotfiles>dotfiles repository</a>. Many of the containers need tokens such as Cloudflare, API keys, you name it, that obviously must not end up on GitHub. Every time I sat down to migrate the stack I put it off for this single reason.</p><p>One free weekend I finally dug into secret management on NixOS and discovered <a href=https://github.com/ryantm/agenix>Agenix</a>. At first the plan was to write a quick post about Agenix alone, but it made more sense to walk through an end-to-end example: adding a brand-new service, Grafana, to the lab while keeping every line of infrastructure code public.</p><h2 id=adding-a-new-service>Adding a new service!<a href=#adding-a-new-service class=hanchor arialabel=Anchor>#</a></h2><p>The easiest way to explain the workflow is to follow it start to finish. Grafana is a nice self-contained example, so we will add that.</p><p>First, here is the minimal subset of the repository we will touch. I generated this tree view by stripping unrelated files.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── .gitignore
</span></span><span style=display:flex><span>├── flake.nix
</span></span><span style=display:flex><span>├── apps
</span></span><span style=display:flex><span>│   └── nixos
</span></span><span style=display:flex><span>│       └── docker
</span></span><span style=display:flex><span>│           ├── default.nix
</span></span><span style=display:flex><span>│           └── grafana
</span></span><span style=display:flex><span>│               ├── data/
</span></span><span style=display:flex><span>│               ├── default.nix
</span></span><span style=display:flex><span>│               └── docker-compose.yml
</span></span><span style=display:flex><span>├── devices
</span></span><span style=display:flex><span>│   └── farnsworth
</span></span><span style=display:flex><span>│       ├── configurations.nix
</span></span><span style=display:flex><span>│       └── secrets.nix
</span></span><span style=display:flex><span>└── secrets
</span></span><span style=display:flex><span>    ├── docker
</span></span><span style=display:flex><span>    │   └── grafana.age
</span></span><span style=display:flex><span>    └── secrets.nix
</span></span></code></pre></div><h2 id=setting-up-agenix>Setting up Agenix<a href=#setting-up-agenix class=hanchor arialabel=Anchor>#</a></h2><p>Agenix manages secrets with age-encrypted files that are transparently decrypted at activation time. You commit only the ciphertext while the private key never leaves the host.</p><p>Add it to the flake inputs and enable its module. I have replaced unrelated code with ellipses.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Tymscar&#39;s system configuration&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># ... other inputs ...</span>
</span></span><span style=display:flex><span>    agenix <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:ryantm/agenix&#34;</span>;
</span></span><span style=display:flex><span>      inputs<span style=color:#f92672>.</span>nixpkgs<span style=color:#f92672>.</span>follows <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nixpkgs&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#75715e># ... other outputs ...</span>
</span></span><span style=display:flex><span>      agenix<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    }:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>      nixosDeviceConfig <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        device:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>          system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>          linuxUsername <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tymscar&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>device<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixosSystem {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>            specialArgs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>inherit</span> device;
</span></span><span style=display:flex><span>              accountUsername <span style=color:#f92672>=</span> linuxUsername;
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>            modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>              agenix<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>default
</span></span><span style=display:flex><span>              <span style=color:#75715e># ... other modules ...</span>
</span></span><span style=display:flex><span>            ];
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># ... rest of the configuration ...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#75715e># ... nixosConfigurations and darwinConfigurations ...</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Create a top-level secrets directory. Its heart is secrets.nix, which declares which public keys may decrypt which file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  one-password-agenix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPeudL4pX9bw/g9apBN7uOBGjbqOJW/pxLKvZNiAMVWs&#34;</span>;
</span></span><span style=display:flex><span>  farnsworth <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAe9FWKQXgkfRiGEw8P1ajzg5vx4Wg8c/5gMOLAyEGua&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e># </span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;docker/grafana.age&#34;</span><span style=color:#f92672>.</span>publicKeys <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    one-password-agenix
</span></span><span style=display:flex><span>    farnsworth
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The first key lives in 1Password (you can keep yours wherever you want. At first I wanted to keep it on my yubikey, but there are still issues with that approach. I will probably make an update on that&mldr;), so I can always re-encrypt or add devices. The second is the homelab host itself.</p><p>Inside <code>secrets/docker</code> run Agenix to create the encrypted file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix run github:ryantm/agenix -- -e grafana.age --identity /home/tymscar/.ssh/id_agenix
</span></span></code></pre></div><p>Your editor opens a blank buffer. Paste the environment variables Grafana needs, one KEY=value per line. In my case there are three as you can see below:</p><p><img src=/nixos-docker-agenix/agenixSecrets.png alt="“Age secrets in your editor”"></p><p>Next import those secrets into the host configuration. In <code>devices/farnsworth/configurations.nix</code> add a line to pull in <code>secrets.nix</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>imports <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./hardware-configuration.nix</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./secrets.nix</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># other imports ...</span>
</span></span><span style=display:flex><span>  ];
</span></span></code></pre></div><p>Then create <code>devices/farnsworth/secrets.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  age<span style=color:#f92672>.</span>secrets <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    docker-grafana<span style=color:#f92672>.</span>file <span style=color:#f92672>=</span> <span style=color:#e6db74>../../secrets/docker/grafana.age</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Whenever you introduce another service you simply append another attribute.</p><p>And believe it or not, that&rsquo;s basically it when it comes to the secrets. Now the next thing we have to do is actually add the Grafana service.</p><h2 id=adding-the-grafana-service>Adding the Grafana service<a href=#adding-the-grafana-service class=hanchor arialabel=Anchor>#</a></h2><p>I keep every container under <code>apps/nixos/docker</code>. The <code>default.nix</code> there enables Docker on the host and imports one subdirectory per service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  imports <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>./grafana</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  virtualisation<span style=color:#f92672>.</span>docker<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Because the folder <code>apps/nixos/docker/grafana</code> contains its own <code>default.nix</code>, Nix treats the directory as a module.
Here is that file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs<span style=color:#f92672>,</span> config<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  dockerEnv <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>age<span style=color:#f92672>.</span>secrets<span style=color:#f92672>.</span>docker-grafana<span style=color:#f92672>.</span>path;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  systemd<span style=color:#f92672>.</span>services<span style=color:#f92672>.</span>grafana <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Grafana&#34;</span>;
</span></span><span style=display:flex><span>    after       <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;network.target&#34;</span> <span style=color:#e6db74>&#34;docker.service&#34;</span> ];
</span></span><span style=display:flex><span>    wants       <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;docker.service&#34;</span> ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    serviceConfig <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      ExecStart  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>docker<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/docker compose --env-file </span><span style=color:#e6db74>${</span>dockerEnv<span style=color:#e6db74>}</span><span style=color:#e6db74> -f docker-compose.yml up --force-recreate&#34;</span>;
</span></span><span style=display:flex><span>      ExecStop   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>pkgs<span style=color:#f92672>.</span>docker<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/docker compose -f docker-compose.yml down&#34;</span>;
</span></span><span style=display:flex><span>      WorkingDirectory <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/home/tymscar/dotfiles/apps/nixos/docker/grafana&#34;</span>;
</span></span><span style=display:flex><span>      Restart    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;always&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    wantedBy <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;multi-user.target&#34;</span> ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I prefer to run ordinary docker compose exactly as on any other distro but let systemd own the lifecycle. The only special part is the <code>--env-file</code> flag, which points at the decrypted Age file supplied by Nix.</p><p>The compose file itself is vanilla:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3.5&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>grafana</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>grafana/grafana-oss:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>grafana</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>data:/var/lib/grafana</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>GF_AUTH_ANONYMOUS_ENABLED=false</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>GF_SERVER_ROOT_URL=https://${GRAFANA_HOST}/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>proxy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.grafana.entrypoints=http&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.grafana.rule=Host(`${GRAFANA_HOST}`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.middlewares.grafana-https-redirect.redirectscheme.scheme=https&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.grafana.middlewares=grafana-https-redirect&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.grafana-secure.entrypoints=https&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.grafana-secure.rule=Host(`${GRAFANA_HOST}`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.grafana-secure.tls=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.grafana-secure.service=grafana&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.grafana.loadbalancer.server.port=3000&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.docker.network=proxy&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>proxy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Finally add runtime directories like <code>data/</code> to <code>.gitignore</code> so they do not clutter the repo:</p><pre tabindex=0><code class=language-gitignore data-lang=gitignore>apps/nixos/docker/grafana/data
</code></pre><h2 id=deploying-the-service>Deploying the service<a href=#deploying-the-service class=hanchor arialabel=Anchor>#</a></h2><p>Deployment is the best part: commit, push and rebuild.</p><p>First stage the new files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git add .
</span></span><span style=display:flex><span>git commit -m <span style=color:#e6db74>&#34;add grafana service&#34;</span>
</span></span></code></pre></div><p>Then switch the host to the new flake:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nixos-rebuild switch --flake <span style=color:#e6db74>&#39;.#farnsworth&#39;</span>
</span></span></code></pre></div><p>Seconds later Grafana is up behind Traefik and SSL. Browse to the hostname you set in the compose file and log in with the admin credentials from the secret. (You also want to point your domain to the Traefik instance, but again, outside the scope of this post)</p><p><img src=/nixos-docker-agenix/grafanaLogin.png alt="“Logging into Grafana with the secret details”"></p><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>#</a></h2><p>This approach ticks every box for me: declarative infrastructure, secrets that stay secret, and plain old Docker where it makes sense. I could not find another write-up that pieced these parts together, so now there is one. Thanks for reading, and happy hacking.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><a href=/posts/nixprivatenpmrepos/ class="button inline next">[<span class=button__text>Using Nix to build JS/TS projects with private dependencies</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>