<!doctype html><html lang=en><head><title>How I deploy private GitHub projects to local self-hosted servers (CI/CD) :: The Tymscar Blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="How I deploy private GitHub projects to local self-hosted servers (CI/CD)"><meta name=keywords content="development,linux,technical,CI/CD,docker,git"><meta name=robots content="noodp"><link rel=canonical href=/posts/privategithubcicd/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/blue.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="google.com"><meta name=twitter:creator content="tymscar"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="How I deploy private GitHub projects to local self-hosted servers (CI/CD)"><meta property="og:description" content="How I deploy private GitHub projects to local self-hosted servers (CI/CD)"><meta property="og:url" content="/posts/privategithubcicd/"><meta property="og:site_name" content="The Tymscar Blog"><meta property="og:image" content="/img/favicon/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-08-12 18:04:45 +0100 +0100"></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Tymscar</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=/posts/privategithubcicd/>How I deploy private GitHub projects to local self-hosted servers (CI/CD)</a></h1><div class=post-meta><span class=post-date>2023-08-12
</span><span class=post-author>:: Oscar Molnar</span></div><span class=post-tags>#<a href=/tags/development/>development</a>&nbsp;
#<a href=/tags/linux/>linux</a>&nbsp;
#<a href=/tags/technical/>technical</a>&nbsp;
#<a href=/tags/ci/cd/>CI/CD</a>&nbsp;
#<a href=/tags/docker/>docker</a>&nbsp;
#<a href=/tags/git/>git</a>&nbsp;</span><div class=post-content><div><h1 id=how-i-deploy-private-github-projects-to-local-self-hosted-servers-cicd>How I deploy private GitHub projects to local self-hosted servers (CI/CD)<a href=#how-i-deploy-private-github-projects-to-local-self-hosted-servers-cicd class=hanchor arialabel=Anchor>&#8983;</a></h1><p>I have a lot of experience with massive CI/CD pipelines that deploy private code to public servers. I&rsquo;ve also worked with pipelines that deploy public repositories to private servers, such as my homelab. However, I never experimented with a pipeline that takes a private GitHub repo, builds it, and deploys it to a server on the LAN. That&rsquo;s precisely what I needed for a project I&rsquo;m currently working on that isn&rsquo;t yet public.</p><p>I took some time to design the best method for this. The two top ideas were: running a self-hosted GitHub Actions runner, which would then redeploy the service in the same LAN as the runner, or hosting a Docker container on a Proxmox VM. This container would act as a webhook and later redeploy the service on the same VM. I chose the second option because it offers more flexibility for future scenarios, such as deploying from repositories hosted on other platforms like GitLab.</p><p>Here&rsquo;s what the workflow looks like:</p><pre tabindex=0><code class=language-ascii data-lang=ascii>     +---------------------+
     | Code gets modified  |
     | and commited to the |
     | github repository   |
     +----------+----------+
                |
                v
       +------------------+
       | A github action  |
       | script downloads |
       | builds and lints |
       | the code         |
       +--------+---------+
                |
                v
     +----------------------+
     | This POST request is |
     | then routed through  |
     | a cloudflare tunnel  |
     +----------+-----------+
                |
                v
    +------------------------+
    | If all of that         |
    | passes successfully    |
    | send the redeploy      |
    | command to the webhook |
    | container              |
    +-----------+------------+
                |
                v
    +------------------------+
    | The webhook container  |
    | now inside of the lan  |
    | SSH&#39;es into the host   |
    | VM and recreates the   |
    | project docker compose |
    | stack                  |
    +-----------+------------+
                |
                v
     +----------------------+
     | The project docker   |
     | compose has a custom |
     | entrypoint that gets |
     | run every time it is |
     | recreated            |
     +----------+-----------+
                |
                v
    +------------------------+
    | This entrypoint script |
    | loads the private key  |
    | approved by github,    |
    | downloads the repo,    |
    | build the project,     |
    | and serves it locally  |
    +-----------+------------+
                |
                v
+--------------------------------+
| Because of some extra          |
| traefik configuration          |
| parametres in the docker       |
| compose file, the project      |
| is then exposed on the lan     |
| behind a valid SSL certificate |
+--------------------------------+
</code></pre><h2 id=the-github-action>The GitHub Action<a href=#the-github-action class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Creating a GitHub Action is straightforward. You need to create a YAML file that instructs GitHub what to do. In our case, we want it to execute every time code is committed to <code>main</code>.</p><p>The filename isn&rsquo;t crucial, but its location is. Mine is in the <code>.github/workflows</code> directory in the repo and is named <code>build_and_publish.yaml</code>.</p><p>The YAML is relatively easy to understand; it has two jobs. One job downloads, builds, and lints the code. The other, &ldquo;publish&rdquo;, triggers the webhook in our local LAN to republish the project. The &ldquo;publish&rdquo; job only executes if the &ldquo;build&rdquo; job completes without errors.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build and Publish</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Checkout code</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Use Node.js</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/setup-node@v2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>node-version</span>: <span style=color:#e6db74>&#39;18&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install Dependencies</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm ci</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Lint</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm run lint</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm run build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>publish</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>needs</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Trigger Webhook</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          RESPONSE=$(curl -X POST https://webhook.tymsc.ar/hooks/redeploy)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;$RESPONSE&#34;</span>          
</span></span></code></pre></div><h2 id=the-cloudflare-tunnel-and-the-webhook-container>The Cloudflare tunnel and the webhook container<a href=#the-cloudflare-tunnel-and-the-webhook-container class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The tunnel&rsquo;s purpose is to avoid exposing my local LAN&rsquo;s homelab ports to the internet. With a Cloudflare tunnel, I can control any exposed service and manage its traffic.</p><p>I chose to host both the tunnel and the webhook container on a VM in my local Proxmox server using Docker Compose. Here&rsquo;s the <code>docker-compose.yml</code> for them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>webhook</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>context</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>Dockerfile</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>webhook</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PUID=1000</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PGID=1000</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TZ=Europe/London</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>EXTRA_PARAM=-hotreload</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/root/webhook:/config</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/root/webhook/secrets/webhook_id_rsa:/etc/ssh_keys/id_rsa:rw</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.webhook.entrypoints=http&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.webhook.rule=Host(`webhook.tymsc.ar`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.middlewares.webhook-https-redirect.redirectscheme.scheme=https&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.webhook.middlewares=webhook-https-redirect&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.webhook-secure.entrypoints=https&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.webhook-secure.rule=Host(`webhook.tymsc.ar`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.webhook-secure.tls=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.webhook-secure.service=webhook&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.webhook.loadbalancer.server.port=9000&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.docker.network=proxy&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>proxy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tunnel</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>cloudflared-tunnel-webhook</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>cloudflare/cloudflared</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>tunnel run</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TUNNEL_TOKEN= ### SECRET KEY HERE</span> <span style=color:#75715e>###</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>proxy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>proxy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Any <code>labels</code> you see are optional. I included them to route internal traffic and assign SSL certificates.</p><p><code>PUID</code> and <code>PGID</code> labels are there to grant necessary permissions to the webhook user later.</p><p>The <code>TUNNEL_TOKEN</code> variable is the key from Cloudflare you get when creating a tunnel. To get yours, visit Cloudflare -> Zero Trust -> Access -> Tunnels, and establish a tunnel with your desired URL, in my case, <code>webhook.tymsc.ar</code>.</p><p>Because the tunnel and webhook service are defined in this Docker Compose file, they can reference each other by name. So, in the Cloudflare online console, when you create the tunnel, set the Service parameter to <code>http://webhook:9000</code>. 9000 is the default port for <code>roxedus/webhook</code>.</p><p>An observant reader might notice the webhook container uses a Dockerfile instead of a container name. That&rsquo;s because I needed SSH access on that container, and the base container didn&rsquo;t have it. So, I added it. Here&rsquo;s the Dockerfile:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> roxedus/webhook</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk --no-cache add openssh-client<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Here&rsquo;s the folder structure for the webhook service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.
</span></span><span style=display:flex><span>|-- Dockerfile
</span></span><span style=display:flex><span>|-- docker-compose.yml
</span></span><span style=display:flex><span>|-- hooks
</span></span><span style=display:flex><span>|   <span style=color:#e6db74>`</span>-- hooks.json
</span></span><span style=display:flex><span>|-- scripts
</span></span><span style=display:flex><span>|   <span style=color:#e6db74>`</span>-- redeploy.sh
</span></span><span style=display:flex><span><span style=color:#e6db74>`</span>-- secrets
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`</span>-- webhook_id_rsa
</span></span></code></pre></div><p>We discussed the first two, but what about the others?</p><p><code>webhook_id_rsa</code> inside <code>secrets</code> is the SSH key allowing this container to SSH into the Proxmox VM hosting it, and the project&rsquo;s container we want to deploy.</p><p>The <code>hooks/hooks.json</code> file has a definition of hooks and their actions. Currently, there&rsquo;s only one hook, <code>redeploy</code>, which executes the <code>redeploy.sh</code> script in the scripts directory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;redeploy&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;execute-command&#34;</span>: <span style=color:#e6db74>&#34;/config/scripts/redeploy.sh&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;command-working-directory&#34;</span>: <span style=color:#e6db74>&#34;/config/scripts&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;response-message&#34;</span>: <span style=color:#e6db74>&#34;✅ Redeploying project!&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>COMMAND<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;nohup docker compose -f /root/project/docker-compose.yml up --force-recreate --build -d &amp;&#34;</span>
</span></span><span style=display:flex><span>HOST_IP<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>ip route | awk <span style=color:#e6db74>&#39;/default/ { print $3 }&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ssh-keyscan $HOST_IP &gt; /root/.ssh/known_hosts
</span></span><span style=display:flex><span>ssh -i /etc/ssh_keys/id_rsa root@$HOST_IP -o StrictHostKeyChecking<span style=color:#f92672>=</span>no -o UserKnownHostsFile<span style=color:#f92672>=</span>/dev/null $COMMAND
</span></span></code></pre></div><h2 id=the-project-container>The project container<a href=#the-project-container class=hanchor arialabel=Anchor>&#8983;</a></h2><p>This is much simpler than the webhook container. Here&rsquo;s its folder structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.
</span></span><span style=display:flex><span>|-- Dockerfile
</span></span><span style=display:flex><span>|-- docker-compose.yml
</span></span><span style=display:flex><span>|-- entrypoint.sh
</span></span><span style=display:flex><span><span style=color:#e6db74>`</span>-- secrets
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`</span>-- id_rsa
</span></span></code></pre></div><p>The <code>secrets/id_rsa</code> file is an SSH private key allowing us to download a private GitHub repository. Its public counterpart was uploaded to GitHub.</p><p>Here&rsquo;s the <code>docker-compose.yml</code> file for the project container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>project</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>context</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>Dockerfile</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>project</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;5000:5000&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/root/project/secrets:/secrets</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.project.entrypoints=http&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.project.rule=Host(`project.tymsc.ar`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.middlewares.project-https-redirect.redirectscheme.scheme=https&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.project.middlewares=project-https-redirect&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.project-secure.entrypoints=https&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.project-secure.rule=Host(`project.tymsc.ar`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.project-secure.tls=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.project-secure.service=project&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.project.loadbalancer.server.port=5000&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.docker.network=proxy&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>proxy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>proxy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Like before, the <code>labels</code> are optional. They&rsquo;re there to access <code>project.tymsc.ar</code> locally, with SSL certificates handled by Traefik.</p><p>The critical part is the secrets passed as a volume and the use of a custom Dockerfile. Here&rsquo;s the Dockerfile:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:18</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y git openssh-client <span style=color:#f92672>&amp;&amp;</span> npm install -g serve<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> entrypoint.sh /entrypoint.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x /entrypoint.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 5000</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;/entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>As you can see, each time this runs, it calls an <code>entrypoint.sh</code> script. This ensures tasks inside it execute every time this container is recreated. As you now know, this happens every time the webhook is called. Let&rsquo;s look at the script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>mkdir -p ~/.ssh
</span></span><span style=display:flex><span>cp /secrets/id_rsa ~/.ssh/
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>600</span> ~/.ssh/id_rsa
</span></span><span style=display:flex><span>ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git clone git@github.com:tymscar/project.git /app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cd /app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>npm install
</span></span><span style=display:flex><span>npm run build
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>serve -s build -p <span style=color:#ae81ff>5000</span>
</span></span></code></pre></div><p>The first half of it handles the SSH keys for the private repo and downloads the project, while the last half installs the dependencies, builds it, and serves it to the LAN. At that point, if you go to the IP of the VM where you&rsquo;re running this container and access port 5000, you should be able to see your project. Because I have the traefik labels set up, I can go to project.tymsc.ar and see it there.</p><p>And that&rsquo;s basically it.</p><h2 id=thoughts>Thoughts<a href=#thoughts class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The beauty of this approach is that if later down the line I want to do this with another private project, all I need to do is add another hook to the webhook container, create the project container just like this last one, and make sure the project has a GitHub action that triggers the webhook.</p><p>The best part is that this is not GitHub-specific either. If later down the line I want to move to GitLab, or I have a self-hosted Gitea instance, the same logic would apply. I would just need to find a way to trigger the webhook on a merge to the main branch.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/gaussiansplat/><span class=button__icon>←</span>
<span class=button__text>Playing around with Gaussian Splat</span>
</a></span><span class="button next"><a href=/posts/jetbrainsremotedevservernixos/><span class=button__text>Running Jetbrains remote dev servers on NixOS</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>